---
title: "Ag Finance Databook"
author: "Mindy L. Mallory"
date: "March 12, 2018"
output: html_document
---

Working with the [Ag Finance Databook](https://www.kansascityfed.org/research/indicatorsdata/agfinancedatabook)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, warning=FALSE, message=FALSE)
```

```{r}
# install.packages("tidyverse")
library(tidyverse)
library(readxl)



url <- "https://www.kansascityfed.org/~/media/files/publicat/research/indicatorsdata/agfinance/historicaldata-dbk.xlsx"
destfile <- "databook.xlsx"
download.file(url, destfile, mode = 'wb')
```


Getting the 'a' tables in. 
```{r}
# 'a' tables



data.a1  <- read_excel("databook.xlsx", sheet = "afdr_a1")
data.a2  <- read_excel("databook.xlsx", sheet = "afdr_a2")
data.a3  <- read_excel("databook.xlsx", sheet = "afdr_a3")
data.a4  <- read_excel("databook.xlsx", sheet = "afdr_a4")
data.a5  <- read_excel("databook.xlsx", sheet = "afdr_a5")
data.a6  <- read_excel("databook.xlsx", sheet = "afdr_a6")
data.a7  <- read_excel("databook.xlsx", sheet = "afdr_a7")
data.a8  <- read_excel("databook.xlsx", sheet = "afdr_a8")
data.a9  <- read_excel("databook.xlsx", sheet = "afdr_a9")
data.a10  <- read_excel("databook.xlsx", sheet = "afdr_a10")
data.a11  <- read_excel("databook.xlsx", sheet = "afdr_a11")
data.a12  <- read_excel("databook.xlsx", sheet = "afdr_a12")
data.a13  <- read_excel("databook.xlsx", sheet = "afdr_a13")
data.a14  <- read_excel("databook.xlsx", sheet = "afdr_a14")

```

Getting the 'b' tables in.
```{r}
data.b1  <- read_excel("databook.xlsx", sheet = "afdr_b1")
data.b2  <- read_excel("databook.xlsx", sheet = "afdr_b2")
data.b3  <- read_excel("databook.xlsx", sheet = "afdr_b3")
data.b4  <- read_excel("databook.xlsx", sheet = "afdr_b4")
data.b5  <- read_excel("databook.xlsx", sheet = "afdr_b5")
data.b6  <- read_excel("databook.xlsx", sheet = "afdr_b6")
data.b7  <- read_excel("databook.xlsx", sheet = "afdr_b7")
data.b8  <- read_excel("databook.xlsx", sheet = "afdr_b8")
data.b9  <- read_excel("databook.xlsx", sheet = "afdr_b9")
```

Getting the 'c' tables in.

```{r}
data.c1  <- read_excel("databook.xlsx", sheet = "afdr_c1")
data.c2  <- read_excel("databook.xlsx", sheet = "afdr_c2")
data.c3  <- read_excel("databook.xlsx", sheet = "afdr_c3")
data.c4  <- read_excel("databook.xlsx", sheet = "afdr_c4")
data.c5  <- read_excel("databook.xlsx", sheet = "afdr_c5")
data.c6  <- read_excel("databook.xlsx", sheet = "afdr_c6")
data.c7  <- read_excel("databook.xlsx", sheet = "afdr_c7")

```


# Historical Coverage

## The 'a' Tables

Section A of the Agricultural Finance Databook are from quarterly sample surveys for non-real-estate farm loans of $1,000 or more made by commercial banks. a1-a7 'attempt to show estimates that are comparable to those that have been presented for a number of years.' 

| a table |  Range                                   |
|:-----------------------------|:---------------------------------|
|a1-a6    | 1977- annual and quarters  |
|a7       | 1987- quarters              |
|a8-a13   | 1999Q4- quarters            |

## The 'b' Tables

Section B of the AFD are quarterly reports of condition and income for commercial banks. 

| b table |  Range                                   |
|:-----------------------------|:---------------------------------|
|b1       | 1973- Q4, 1986-quarterly   |
|b2       | 1987- quarterly            |
|b3       | 1984- annual                     |
|b4       | 1991- annual and quarters   |
|b5       | 1991- annual and quarters  |
|b6       | 1987- quarterly  |
|b7       | 1988- quarterly, 1977- annual |
|b8       | 1975- quarterly  |
|b9       | 1981- quarterly  | 

## The 'c' Tables

Section C of the AFD are quarterly surveys of agricultural credit conditions and farmland values at commercial banks. 

| c table |  Range                                   |
|:-----------------------------|:---------------------------------|
|c1       | 1991-quarterly   |
|c2       | 1991-quarterly            |
|c3       | 1991-quarterly                     |
|c4       | 1991-quarterly    |
|c5       | 2001- quarterly  |
|c6       | 1991-quarterly  |
|c7       | 2001- quarterly |

 

```{r}

data.b6[data.b6 == "."] <- 0

table_list <- list(data.a3, data.a4, data.a5, data.a6, data.b1[,1:3], data.b2, data.b6)



tables   <- left_join(data.a1, data.a2, by = "Period")
n <- length(table_list)

for(i in 1:n){
  
  tables <- left_join(tables, table_list[[i]], by = "Period")
  
}
tables <- tables[41:dim(tables)[1],]
tables <- tables[, -86]

```

## Potential independent variables

Share of outstanding loans Non-performing total: column 83

Share of outstanding loans Non-performing, 90 days past due, accrueing: column 84

Share of outstanding loans Non-performing, non-accrueing: column 85



```{r}
# Partial Least Squares
library(pls)



tables  <- tables %>% na.omit %>% as.data.frame
tables  <- cbind(tables[2:dim(tables)[1], 83], tables[1:(dim(tables)[1]-1), c(-2, -83)]) # dplyr was not lagging correctly so I lagged by hand and made col 83 first col
train   = sample(1:nrow(tables), nrow(tables)/2)
test    = tables[-train,]
pls.fit = plsr(tables[, 1]~., data = tables, subset = train, scale = FALSE, validation = "CV")
summary(pls.fit)

validationplot(pls.fit,val.type="MSEP")
pls.pred=predict(pls.fit, ncomp=2)[-train]
mean((pls.pred-test[, 1])^2)
plot(pls.fit)
```


```{r}
library(glmnet)
grid    <-10^seq(10,-2,length=100)
tables2 <- data.matrix(tables)
lasso.mod=glmnet(tables2[train , c(-1, -2)], tables2[train, 1],alpha=1,lambda=grid)
plot(lasso.mod)

cv.out <- cv.glmnet(tables2[train , c(-1, -2)], tables2[train, 1], alpha = 1)
plot(cv.out)

bestlam=cv.out$lambda.min
lasso.pred=predict(lasso.mod,s=bestlam, newx=tables2[-train , c(-1, -2)])
mean((lasso.pred-test[, 1])^2)


out=glmnet(tables2[ , c(-1, -2)], tables2[, 1], alpha=1, lambda=grid)
lasso.coef=predict(out,type="coefficients",s=bestlam)[1:20,]
lasso.coef
lasso.coef[lasso.coef!=0]

```